---
title: "Supplementary Material S1: Theory for \"A theoretical framework for upscaling species distribution models\""
author: Christine N. Meynard, Cyril Piou, David M. Kaplan

bibliography: "supplementary-s1-theory.bib"
csl: dmk-format.csl

output:
  bookdown::pdf_document2:
    df_print: kable
    toc: true
    toc_depth: 3
    keep_tex: true

always_allow_html: true
urlcolor: blue
linkcolor: blue

# These are LaTex settings to take care of floating figures/tables, line spacing, etc
header-includes:
  - \usepackage[nomarkers,tablesfirst]{endfloat}    
  - \usepackage{setspace}\doublespacing
  - \usepackage{lineno}
  - \linenumbers
  - \usepackage{tocloft}
  - \setlength{\cftsecnumwidth}{3em}
  - \setlength{\cftsubsecnumwidth}{3em}
  - \setlength{\cftsubsubsecnumwidth}{4em}
---

<!-- For Latex section, figure and table numbering -->
\renewcommand\thesection{S1.\arabic{section}}
\renewcommand\thefigure{S1.\arabic{figure}}
\renewcommand\thetable{S1.\arabic{table}}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(fig.pos = 'p') # Places figures on their own pages
knitr::opts_chunk$set(out.width = '100%', dpi=300)

library(foreach)
library(tidyverse)
library(fields)
library(mgcv)
library(PresenceAbsence)

library(ggplot2)
library(grid)
library(gridExtra)

# Define alpha and beta for logistic curve
beta = 7.5
alpha = 0.3
```

```{r downloadbib, eval=FALSE}
# Download bib file if not exists
bibfn = "supplementary-s1-theory.bib"
#biburl = "http://127.0.0.1:23119/better-bibtex/export/library?/11/library.bibtex"
#download.file(url=biburl,destfile=bibfn)
```


# Baseline theory for upscaling effects

Building off of the theory developed in @meynardTestingMethodsSpecies2019, we want to understand how probability of species occurrence changes as a function of how we aggregate sampling (and environmental covariate) data. Suppose that we have a set of sites, $\{i\}$, at which fieldwork is carried out to assess species presence-absence. We assume that species presence at a given site $i$ is a binomial stochastic process with probability of occurrence (i.e., presence), $p_i$, being a function of one or more environmental covariates. Implicitly in this formulation we assume that site $i$ being occupied has no impact on the occurrence in nearby site $j$. This means that individual sites are far enough apart (or big enough) that we are beyond the scale of nearest-neighbor colonization events so that occurrence at one site is independent of occurrence at all other sites (*note:* given this assumption, probability of occurrence *can* have spatial auto-correlation due to spatial auto-correlation in environmental covariates, it is just occurrence itself that must be a perfect stochastic process of the environmentally-determined probability of occurrence). Later we reflect on what would happen if there was correlation in occurrence between sites due to colonization events.

Now suppose that we want to group presence-absence observations at several such sites, e.g., to match the spatial scales of environmental data. There are at least 3 approaches to doing this (also see Fig. 1 in the paper):

1) One could randomly sample one of the sub-sites within an aggregate and declare the aggregate to be a presence if that randomly sampled site was a presence (Fig. 1a).
    * This is equivalent to what would happen if one had a fixed amount of sampling effort to determine if a species is present in a small subset of all possible sites. The set of presences and absences that one observes could be associated with (environmental) covariate information on different spatial scales, but increasing or decreasing this scale will not change one's declaration of the corresponding site as a presence or an absence because there is essentially never more than one site sampled per aggregate.
    * An aggregate being considered a presence would then just mean that the species was present at the (smaller) sampled site. Nevertheless, one would model as if the species was present throughout the grid cell. If environmental covariates represent an average over the entire aggregate and environment is not constant throughout the aggregated sites, then differences between average environmental conditions and the specific conditions at the sampled site within an aggregate could produce variability or bias in our estimates of species environment-occurrence relationships.
2) Another possibility is to declare an aggregate a presence if the species is present in any sub-site within the aggregate (Fig. 1b).
    * This is what would happen if one was aggregating species observations over space (or time), so that sampling effort increases proportional to the size of the aggregate.
    * This approach is exactly equivalent to declaring an absence if and only if the species is absent from all sub-sites within an aggregate.
3) A final possibility is to declare an aggregate as a presence if and only if all sites within the aggregate are occupied (Fig. 1c).
    * This unlikely choice is essentially the inverse of approach #2, and, therefore, it has the same theoretical behavior (but in an inverse sense) as approach #2. As such, we will present primarily approach #2 and only briefly mention approach #3.

If there is very strong spatial autocorrelation among observations of occurrence due, e.g., to nearest-neighbor colonization and extinction processes, then species presence in any one site in an aggregate will guarantee presence in all sites of an aggregate. In this case, assessments of species presence based on a single site (i.e., approach #1) are no different than assessments based on all sites in the aggregate and approach #2 reduces to approach #1. Therefore, approaches #1 and #2 essentially bound the possibilities of what will happen if local species nearest-neighbor colonization and extinction processes are important or negligible, respectively, on the scale of individual sites.

For all three approaches described above, we would like to derive the probability of "occurrence" in an aggregate based on the probabilities of occurrence of the sites (or observations) that are inside the aggregate. Initially we will assume that environmental conditions are constant within each aggregate (or, in an approximate sense, that the scale of aggregation is considerably inferior to the spatial autocorrelation scales of environmental variability). For this case, one can develop a relatively simple set of analytic equations describing what will happen to probability of occurrence as a function of level of aggregation. Once we understand this theory, we will then turn our attention to how environmental variability within aggregates will impact bias and variability in estimated environment-occurrence relationships. 

Approach #1 is relatively simple to analyze, so we will develop it first before proceeding to the more complex Approach #2.

## Approach \#1

Approach #1 will achieve on an average an unbiased estimate of probability of occurrence within an aggregate. If single sites are randomly drawn from within an aggregate many times, the average percent occurrence of the sites drawn (i.e., the average of the zeros representing absences and ones representing presences) will just reflect the percentage of presences within the aggregate. As the percentage of presences within an aggregate is simply a reflection of the mean (environmentally-determined) probability of occurrence of all sites within the aggregate, on average over many such upscalings the perceived probability of occurrence will simply be the mean of the probabilities of occurrence of the sites that compose the aggregate. If we assume that environmental conditions are the same for all sites within the aggregate, then probability of occurrence will be the same for any site within the aggregate and the probability of occurrence of the aggregate based on approach #1 will simply be the probability of occurrence for any individual site within the aggregate. As such, the environment-occurrence relationship will be unchanged by the aggregation process.

However, the observed relationship between average environmental conditions over the aggregate and average probability of occurrence over the aggregate may differ from the underlying (site-level) environment-occurrence relationship if environment varies within an aggregate. Differences will potentially be important if the environment-occurrence relationship is a non-linear function of environment over the range of conditions within an aggregate. This possibility will be considered in more detail later on in the document.

One might think that upscaling would also increase the variance (i.e., RMS difference) between the observed aggregate presence-absence map and the aggregated probability of occurrence because randomly sampling a single cell may in some cases very poorly reflect the average probability of occurrence (e.g., by randomly selecting the one cell in an aggregate that is actually occupied), but this will not on average be the case as every site is an equally valid potential presence and the probability of occurrence of that site contributes equally to the average probability of occurrence over the aggregate. An increase in discrepancy between the presence-absence map and predicted probability of occurrence would be entirely due in this case to the reduced number of "sites" after the aggregation process.

## Approach \#2

For approach #2, the upscaled probability of occurrence in the aggregate is the probability that at least one of the sampled sites within the aggregate is a presence. This is the same as one minus the probability that none of the sites in an aggregate are occupied. As the probability that none of the sites in an aggregate is occupied is the probability that site 1 is an absence *AND* site 2 is an absence *AND* site 3 is an absence..., this can be calculated as the product of the probabilities of absence in each site:

\begin{equation}\label{eq:eq1}
\tilde{p} = 1 - \prod_{i=1}^{\nu} (1-p_i)
\end{equation}

where $\nu$ is the number of sites in the aggregate. Note that this reduces to $\tilde{p}=p$ for the case $\nu=1$, as one would expect.

If environment is constant over all sites within an aggregate (i.e., $p_i=p$), then the aggregate probability of occurrence, $\tilde{p}$, becomes:

\begin{equation}\label{eq:tildep}
\tilde{p} = 1 - (1-p)^\nu
\end{equation}

Note that this equation can be inverted to give the probability of occurrence in a single site as a function of the probability of occurrence of the aggregate:

\begin{equation}\label{eq:invtildep}
p = 1 - (1-\tilde{p})^{1/\nu}
\end{equation}

### Case of a logistic probability of occurrence

One special case of the logic above for constant environment within aggregates for which a number of intuitive analytic results can be obtained is when probability of occurrence is a logistic function of a single environmental variable, $x$:

\begin{equation}\label{eq:logistic}
p(x) = \frac{1}{1+e^{(x-\beta)/\alpha}}
\end{equation}

This formulation is reasonably representative of any one-sided environmental gradient in probability of occurrence. If $\alpha>0$, then probability of occurrence will approach one for $x << 0$ and it will approach zero for $x >> 0$. The inflection point of the logistic curve occurs when $x=\beta$ and $p=\frac{1}{2}$. At this inflection point, the slope of the environment-occurrence relationship is $-\frac{1}{4 \alpha}$.

We would like to understand the behavior of this type of environment-occurrence relationship as we aggregate probability of occurrence over multiple sites following approach #2. In particular, we would like to understand at least three things:

1) How does the environmental point at which $\tilde{p}=\frac{1}{2}$ change as a function of the level of aggregation?
2) How does the inflection point change as a function of level of aggregation?
3) How does the steepness at the inflection point change as a function of level of aggregation? Does the environment-occurrence relationship become more threshold-like as level of aggregation is increased?

In order to develop analytic relationships that answer these questions, it is useful to first note that the logistic function can be inverted to get the value of the environment $x$ corresponding to a probability of occurrence $p$:

\begin{equation}\label{eq:invlogistic}
x = \beta + \alpha \left[ \log(1-p) - \log(p) \right]
\end{equation}

This, in combination with Eq. \ref{eq:invtildep} can be used to get the environmental values corresponding to a value of the theoretical upscaled probability of occurrence:

\begin{equation}\label{eq:invlogtilde}
x = \beta + \alpha \left[ \frac{1}{\nu} \log(1-\tilde{p}) - \log \left(1-(1-\tilde{p})^{1/\nu} \right) \right]
\end{equation}

This can also be written:

$$
x = \beta - \alpha \log \left((1-\tilde{p})^{-1/\nu} - 1 \right)
$$

This equation can be useful to look at what environmental conditions produce a given value of aggregated probability of occurrence as a function of $\nu$. In particular, we can look at what value of environment produces $\tilde{p}=\frac{1}{2}$. Substituting this into Eq. \ref{eq:invlogtilde}, we have:

\begin{equation}\label{eq:x_nu_50}
x_{\nu,0.5} = \beta - \alpha \log \left( 2^{1/\nu} - 1 \right)
\end{equation}

First, note that as $1 \ge 2^{1/(\nu-1)} - 1 > 2^{1/(\nu)} - 1 > \dots > 0$ for all $\nu>1$, we have that $x_{\nu,0.5} > x_{\nu-1,0.5} \ge \beta$, so the environmental value at which probability of occurrence is 50% moves continuously to the right as the level of aggregation (i.e., $\nu$) increases. For large $\nu$, we can use the exponential expansion to estimate this point:

$$
x_{\nu,0.5} \approx \beta - \alpha \log \left( 1 + \frac{1}{\nu} \log 2 - 1 \right)
= \beta + \alpha \log \left( \frac{\nu}{\log 2} \right)
$$
So the position of this point moves rightward approximately at the rate of $\alpha \log \nu$.

Next, to examine the inflection point and the steepness at the inflection point, we need to look at the derivatives of $\tilde{p}(x)$. The inflection of this function is defined as the point at which the second derivative with respect to $x$ is zero. We begin with derivatives of the unaggregated logistic function:

\begin{equation}\label{eq:derivlogistic}
\frac{dp}{dx} = \frac{-1}{\alpha \left( 1+e^{(x-\beta)/\alpha} \right)^2} e^{(x-\beta)/\alpha} = -\frac{p^2}{\alpha} e^{(x-\beta)/\alpha} = -\frac{1}{\alpha} p (1-p)
\end{equation}

and

\begin{equation}\label{eq:deriv2logistic}
\frac{d^2p}{dx^2} = -\frac{1}{\alpha} \left[ (1-p) \frac{dp}{dx} - p  \frac{dp}{dx} \right] = \frac{1}{\alpha^2} p (1-p) (1-2p)
\end{equation}

From this final equation, it is easy to see that the inflection point of the logistic occurs when $p=\frac{1}{2}$, which occurs when $x=\beta$.

We can also look at the derivatives of $\tilde{p}$ to identify it's inflection points:

$$
\frac{d\tilde{p}}{dx} = \nu (1-p)^{\nu-1} \frac{dp}{dx}
$$

For a logistic probability of occurrence, this gives:

\begin{equation}\label{eq:derivlogtilde}
\frac{d\tilde{p}}{dx} = -\frac{\nu}{\alpha} p (1-p)^{\nu}
\end{equation}

The second derivative of $\tilde{p}$ is:

$$
\frac{d^2\tilde{p}}{dx^2} = \nu (1-p)^{\nu-1} \frac{d^2p}{dx^2} - \nu (\nu-1) (1-p)^{\nu-2} \left( \frac{dp}{dx} \right)^2
$$

We can substitute the derivatives of the logistic (Eqs. \ref{eq:derivlogistic} & \ref{eq:deriv2logistic}) into this formula to get a precise location for the inflection point for this specific case:

$$
\frac{d^2\tilde{p}}{dx^2} = \frac{\nu}{\alpha^2} p (1-p)^{\nu} (1-2p) - \frac{\nu}{\alpha^2}  (\nu-1) p^2 (1-p)^{\nu}
$$

$$
\frac{d^2\tilde{p}}{dx^2} = \frac{\nu}{\alpha^2} p (1-p)^{\nu} \left[ 1-2p - (\nu-1) p \right] = \frac{\nu}{\alpha^2} p (1-p)^{\nu} \left[ 1 - (\nu+1) p \right]
$$

From this we see that the inflection point given by $\frac{d^2\tilde{p}}{dx^2} = 0$ occurs when:

\begin{equation}\label{eq:p_nu_inflection}
p_{\nu,\text{infl}} = \frac{1}{\nu+1}
\end{equation}

Note that this is the probability of occurrence of the original, unaggregated logistic function. 
The probability of occurrence in the aggregated environment-occurrence relationship can be derived from this using Eq. \ref{eq:tildep}:

\begin{equation}\label{eq:p_tilde_nu_inflection}
\tilde{p}_{\nu,\text{infl}} = 1 - \left( 1 - \frac{1}{\nu+1} \right)^\nu
= 1 - \left( \frac{\nu}{\nu+1} \right)^\nu
= 1 - \frac{1}{ \left( 1 + \frac{1}{\nu} \right)^\nu }
\end{equation}

Using the well-known limit equation:

\begin{equation}\label{eq:lime}
\lim_{\nu\to\infty} \left( 1 + \frac{1}{\nu} \right)^\nu = e
\end{equation}

we find that for large $\nu$, Eq. \ref{eq:p_tilde_nu_inflection} approaches:

\begin{equation}\label{eq:lim_p_tilde_nu_inflection}
\tilde{p}_{\nu,\text{infl}} \approx 1 -\frac{1}{e} \approx `r round(1 - 1/exp(1),3)`
\end{equation}

Therefore, the probability of occurrence at which the inflection point occurs asymptotes to `r round(1 - 1/exp(1),3)`.

This gives the location of the inflection point as a function of the original, unaggregated logistic probability of occurrence. Substituting this into Eq. \ref{eq:invlogistic} gives the value of the environmental variable at which the inflection occurs:

\begin{equation}\label{eq:x_nu_inflection}
x_{\nu,\text{infl}} = \beta + \alpha \left[ \log \left( \frac{\nu}{\nu+1} \right) - \log \left( \frac{1}{\nu+1} \right) \right] = \beta + \alpha \log(\nu)
\end{equation}

Eq. \ref{eq:x_nu_inflection} indicates that the position of the inflection point moves rightward at precisely the rate $\alpha \log(\nu)$. For large $\nu$, this is approximately the same rate at which the point of $\tilde{p}=\frac{1}{2}$ (Eq. \ref{eq:x_nu_50}) moves to the right, so these two remain at an approximately fixed distance from each other in environmental variable space.

One can also evaluate the steepness at the inflection point using Eq. \ref{eq:derivlogtilde}:

\begin{equation}\label{eq:deriv_p_nu_inflection}
\frac{d\tilde{p}}{dx} \bigg|_{x_{\nu,\text{infl}}} = -\frac{\nu}{\alpha} \frac{1}{\nu+1} \left( \frac{\nu}{\nu+1} \right)^{\nu} = -\frac{1}{\alpha} \left( \frac{\nu}{\nu+1} \right)^{\nu+1}
\end{equation}

Again using Eq. \ref{eq:lime}, we find that for large $\nu$, Eq. \ref{eq:deriv_p_nu_inflection} approaches:

\begin{equation}\label{eq:lim_deriv_p_nu_inflection}
\frac{d\tilde{p}}{dx} \bigg|_{x_{\nu,\text{infl}}} \approx -\frac{1}{e\alpha}
\end{equation}

Therefore, the steepness of the aggregate environment-occurrence relationship does not increase indefinitely, but rather asymptotes toward $\frac{4}{e} \approx `r round(4/exp(1),3)`$ times the steepness of the original, unaggregated logistic species-environment relationship.

Eqs. \ref{eq:x_nu_50}, \ref{eq:p_nu_inflection}, \ref{eq:x_nu_inflection}, \ref{eq:p_tilde_nu_inflection}, \ref{eq:deriv_p_nu_inflection} and \ref{eq:lim_deriv_p_nu_inflection} form the core theoretical results of this analysis regarding the effects of aggregating probabilities of occurrence for sets of sites with similar environmental conditions. They indicate that aggregation moves the center of the transition zone of the probability of occurrence distribution towards more and more marginal habitat areas. This process continues indefinitely as the log of the level of aggregation (in environmental variable space; in real space, movement of the "presence" frontier will depend on the relationship between physical space and environmental conditions; Fig. 2). The steepness of the transition does not, however, increase indefinitely towards a threshold species-environment relationship, but rather asymptotes towards a fixed value no matter what the level of aggregation.

### Impact of aggregation on model performance statistics

One particularly important question regarding the impact of spatial aggregation on SDMs is how indicators of model performance (e.g., AUC, TSS, proportion of correctly classified data, sensitivity and specificity) will vary as a function of spatial scale, with it generally being assumed that higher resolution models will have better performance [@mertesDisentanglingScaleDependencies2018]. When aggregation is carried out following approach #2, whether or not model performance indicators will increase or decrease as a function of the spatial scale of aggregation depends on a number of factors. One is the particular modeling approach used. For example, if one uses logistic regression, then this will fit less well the aggregated data than the unaggregated data as the aggregated data no longer has a true logistic environment-occurrence relationship. However, as we will see when we examine below numerically the theory developed above, divergence from a logistic relationship is generally relatively minor. Furthermore, true environment-occurrence relationships in nature will never be exactly logistic regardless of spatial scale, and this is issue is easily addressed by using a more flexible, non-linear modeling approach, such as general additive models (GAMs) and random forests.

Likely a more important effect is the shape of the environment-occurrence relationship itself. Model performance is essentially determined by areas for which environmental conditions lead to probabilities of occurrence that are far from zero or one. In all other areas, models will have little problem correctly determining occurrence as the species will be (almost) always present or always absent. As aggregation using approach #2 increases the slope of the environment-occurrence relationship, this will have a tendency to reduce the area over which probabilities of occurrence are intermediate, thereby increasing model performance as level of aggregation is increased. However, our analysis shows that the slope (in environmental space) does not increase indefinitely, but rather asymptotes towards a maximum value that is not strongly different from the initial slope. As such, the effect of increased aggregation may be relatively minor.

Perhaps the most important impact of aggregation on model performance indicators is via the range of environmental conditions for which probabilities of occurrence are intermediate. As aggregation is increased, the environmental conditions over which probability of occurrence is rapidly varying will shift (to the right in our logistic formulation provided that $\alpha>0$). Depending on how prevalent these environmental conditions are over space, this could lead to significant changes in model performance. For example, if the range of environmental conditions for which the unaggregated data has intermediate occurrence are far more prevalent in space than the range of environmental conditions for which the aggregated data has intermediate occurrence then model performance will likely increase as data are aggregated. On the other hand, if the reverse is true, model performance will likely decrease as data are aggregated.

## Approach \#3

As previously mentioned, approach #3 is conceptually similar to approach #2, but in an opposite sense. As such, all equations developed in the previous section are valid for approach #3 so long as one replaces $p$ by $1-p$ and $\tilde{p}$ by $1-\tilde{p}$. As a result, aggregation continually lowers the probability of occurrence, moving the transition zone of the environment-occurrence relationship to the left with the same rate and properties (e.g., slope) as developed in the previous section.

# Visualization of theory

Here we visually explore the analytic results developed above for approach #2. The other two approaches will not be given further consideration as approach #3 is conceptually equivalent to (but opposite) approach #2, and approach #1 does not modify the underlying environment-occurrence relationship. This visualization will be based purely on the analytic equations developed above and the relationship between physical space and environment will be ignored (i.e., we assume that environmental conditions do not vary within aggregates at the scales of aggregation examined). Numerical tests of the theory involving real space-environment relationships will be carried out in Section \@ref(numerical) and in Supplementary Material S2.

## Logistic probability of occurence

```{r vistheory0,message=FALSE}
#library(virtualspecies)

# logistic function to remove dependency on virtualspecies
logisticFun = function(x,alpha,beta) 
  1 / (1+exp((x-beta)/alpha))

aggfun = function(p,fact,nu=fact^2) 1-(1-p)^nu

logisticFun.agg = function(x,alpha,beta,fact,nu=fact^2) {
  aggfun(logisticFun(x,alpha,beta),nu=nu)
}

deriv.logisticFun.agg = function(x,alpha,beta,fact,nu=fact^2) {
  p = logisticFun(x,alpha,beta)
  -nu / alpha * p * (1-p)^nu
}

logisticFun.agg.inflection = function(fact=1,nu=fact^2) 1/(nu+1)

inv.logisticFun.agg = function(p,alpha,beta,fact,nu=fact^2) {
  beta + alpha * ( (1/nu) * log(1-p) - log(1-(1-p)^(1/nu)) )
}

inv.logisticFun.agg.inflection = function(alpha,beta,fact,nu=fact^2) {
  inv.logisticFun.agg(logisticFun.agg.inflection(nu=nu),
                      alpha=alpha,beta=beta,nu=1)
}

facts = c(1,2,4,8,16)
factsfacts = paste0(facts,"x",facts)
x = seq(beta-5*alpha,beta+10*alpha,length.out = 1000)
y = do.call(cbind,
            lapply(facts,function(fact) logisticFun.agg(x,alpha,beta,fact)))
```

(ref:capvistheory1) Probability of occurrence for various scales of spatial aggregation. Aggregates are assumed to be square grids of $N \times N$ cells (i.e., $\nu=N^2$). The underlying logistic curve representing species occurrence as a function of environment followed logistic Eq. \ref{eq:logistic} with $\beta=`r beta`$ and $\alpha=`r alpha`$. Vertical dashed lines indicate positions of inflection points.

```{r vistheory1,fig.cap="(ref:capvistheory1)"}
# Prob occ. plus inflection points ----
plot(x,y[,1],lwd=4,type="l",
     xlab="Temperature (\u00B0C)",ylab="Prob. of occurence",
     main="Impact of aggregation on prob. of occurence")
for (k in 2:ncol(y)) {
  lines(x,y[,k],col=k,lwd=4)
}

inflections=sapply(facts,
       function(fact) inv.logisticFun.agg.inflection(alpha,beta,fact))
abline(v=inflections,col=seq_along(inflections),lwd=4,lty="dashed")

legend("bottomleft",legend=factsfacts,col=seq_along(facts),
       lty="solid",lwd=4)
```

<!-- The figure below is currently excluded from supplementary material. Leaving code just in case. -->

(ref:capvistheory2) Derivative of probability of occurrence for various scales of spatial aggregation. Aggregates are assumed to be square grids of $N \times N$ cells (i.e., $\nu=N^2$). The underlying logistic curve representing species occurrence as a function of environment followed logistic Eq. \ref{eq:logistic} with $\beta=`r beta`$ and $\alpha=`r alpha`$. Vertical dashed lines indicate positions of inflection points.

```{r vistheory2,fig.cap="(ref:capvistheory2)",include=FALSE}
# Derivates plus inflection points ------
dy = do.call(cbind,
             lapply(facts,function(fact) 
               deriv.logisticFun.agg(x,alpha,beta,fact)))

plot(x,dy[,1],lwd=4,type="l",ylim=c(min(dy),0),
     xlab="Temperature (\u00B0C)",ylab="Derivative of prob.",
     main="Derivative of prob. occ.")
for (k in 2:ncol(y)) {
  lines(x,dy[,k],col=k,lwd=4)
}

abline(v=inflections,col=seq_along(inflections),lwd=4,lty="dashed")

legend("bottomleft",legend=factsfacts,col=seq_along(facts),
       lty="solid",lwd=4)
```

(ref:capvistheory3) Span of area representing 10% and 90% probability of occurrence for various scales of spatial aggregation. Aggregates are assumed to be square grids of $N \times N$ cells (i.e., $\nu=N^2$). The underlying logistic curve representing species occurrence as a function of environment followed logistic Eq. \ref{eq:logistic} with $\beta=`r beta`$ and $\alpha=`r alpha`$. Vertical dashed lines indicate environmental conditions for which aggregate probability of occurrence is 10% or 90%.

```{r vistheory3,fig.cap="(ref:capvistheory3)"}
# Prob. occ. plus 10%-90% windows -----
w = lapply(facts,function(fact) inv.logisticFun.agg(c(0.9,0.1),alpha,beta,fact))
w = do.call(rbind,w)
dw = apply(w,1,diff)

plot(x,y[,1],lwd=4,type="l",
     xlab="Temperature (\u00B0C)",ylab="Suitability",
     main="10% - 90% windows at several scales")
for (k in 2:ncol(y)) {
  lines(x,y[,k],col=k,lwd=4)
}

abline(v=w,col=seq_along(facts),lwd=2,lty="dashed")

abline(h=c(0.1,0.9),col="gray",lty="dashed")
```

(ref:capvistheory5) Temperature value corresponding to 10% and 90% probability of occurrence for various scales of spatial aggregation. Black central curve shows the temperature of the inflection point as a function of scale. Aggregates are assumed to be square grids of $N \times N$ cells (i.e., $\nu=N^2$). The underlying logistic curve representing species occurrence as a function of environment followed logistic Eq. \ref{eq:logistic} with $\beta=`r beta`$ and $\alpha=`r alpha`$.

```{r vistheory5,fig.cap="(ref:capvistheory5)"}
# Position of 10, inflection, 90 as a function of scale ----
plot(facts,w[,2],ylim=range(w),type="l",lty="dashed",lwd=4,col="red",
     xlab="Scale",ylab="Temperature (\u00B0C)",
     main="Scale vs. 10%,inflection,90%")
lines(facts,w[,1],lwd=4,lty="dashed",col="green")
lines(facts,inflections,lwd=4,col="black")

legend("bottomright",legend=c("Inflection","10%","90%"),
       lty=c("solid","dashed","dashed"),lwd=4,
       col=c("black","red","green"))
```

(ref:capvistheory4) Width of 10%-90% window for probability of occurrence for various scales of spatial aggregation (i.e., width of spans shown in Fig. \@ref(fig:vistheory3)). Aggregates are assumed to be square grids of $N \times N$ cells (i.e., $\nu=N^2$). The underlying logistic curve representing species occurrence as a function of environment followed logistic Eq. \ref{eq:logistic} with $\beta=`r beta`$ and $\alpha=`r alpha`$.

```{r vistheory4,fig.cap="(ref:capvistheory4)"}
# Width 10-90 as a function of scale ----------
plot(facts,dw,main="Scale vs. width 10%-90% window",
     xlab="Scale",ylab="Width of window (\u00B0C)",
     type="b",pch=19)
```

We begin by examining a logistic functional relationship between an environmental variable, in this case taken without loss of generality to be (mean annual) temperature in $^\circ \text{C}$, and the probability of occurrence of a virtual species. The logistic curve representing species probability of occurrence as a function of environment follows Eq. \@ref(eq:logistic) with $\beta=`r beta`$ and $\alpha=`r alpha`$. As mentioned above, the relationship between environment and physical, habitat space is not relevant as we assume that environment does not vary within aggregates at the scales of aggregation considered. We will consider aggregation in a two-dimensional space at the following scales: `r paste(factsfacts, collapse=", ")` (corresponding to $\nu=`r paste(facts^2,collapse=", ")`$).

For these parameter values, the unaggregated probability of occurrence is very close to one in areas with temperatures $<6^\circ \text{C}$ and very close to zero for temperatures $>9^\circ \text{C}$ with intermediate probabilities of occurrence between these two temperatures (Fig. \@ref(fig:vistheory1)). As level of aggregation is increased, the inflection point of the probability of occurrence curve displaces to the right (Fig. \@ref(fig:vistheory1)), as does the range of temperatures for which probability of occurrence is significantly different from zero and one (Fig. \@ref(fig:vistheory3)), at a rate proportional to $log(\nu)=log(N^2)$ (Fig. \@ref(fig:vistheory5)). Though the range of temperatures for which probabilities of occurrence are intermediate shrinks as data are aggregated, this shrinkage more or less reaches the asymptote for aggregation above a scale of 8x8 (Fig. \@ref(fig:vistheory4)).

## Normally distributed probability of occurence

Though a logistic curve is representative of many observed gradients in species occurrence, it is a one-sided gradient that is ultimately unrealistic for species that have lower *and* upper bounds on suitable environmental conditions. To explore the impact of aggregation on a two-sided environment-occurrence relationship, we consider a normally distributed probability of occurrence:

\begin{equation}\label{eq:normprob}
p(x) = C e^{-(x-\mu)^2/\sigma^2}
\end{equation}

where the maximum probability of occurrence, $C$, can be chosen to ensure a certain overall prevalence level over the habitat domain.

```{r applinorm0}
normfun = function(x,mu,sigma,C=1) C*exp(-(x-mu)^2 / sigma^2)
normfun.agg = function(x,mu,sigma,C=1,fact,nu=fact^2)
  aggfun(normfun(x,mu,sigma,C),nu)

sigma = 1
mu = 0
C=1
Clow = 0.5
```

Although analytic results may be possible for species occurrence following a normal distribution, for simplicity we choose to numerically examine changes in the environment-occurrence relationship as a result of aggregation based on the combination of Eq. \@ref(eq:normprob) and Eq. \@ref(eq:tildep). We consider two virtual species with normally distributed environment-occurrence relationships differing in their level of overall habitat occurrence. For both species, $\mu=`r mu`$ and $\sigma=`r sigma`$, but for the high prevalence species $C=`r C`$, whereas for the low occurrence species $C=`r Clow`$

(ref:capapplinorm1)  Probability of occurrence for various scales of spatial aggregation. Aggregates are assumed to be square grids of $N \times N$ cells (i.e., $\nu=N^2$). The underlying logistic curve representing species occurrence as a function of environment followed a normal distribution (i.e., Eq. \@ref(eq:normprob)) with $\mu=`r mu`$, $\sigma=`r sigma`$. $C$, the maximum probability value, was equal to `r C`.

```{r applinorm1,fig.cap="(ref:capapplinorm1)"}
x = seq(-5,5,length.out=1000)
y = lapply(facts,function(fact) normfun.agg(x,mu,sigma,C=C,fact=fact))
y = do.call(cbind,y)

plot(x,y[,1],lwd=4,type="l",
     xlab="Temperature (\u00B0C)",ylab="Prob. of occurence",
     main="Normal prob. occ. at several scales")
for (k in 2:ncol(y)) {
  lines(x,y[,k],col=k,lwd=4)
}

legend("bottomleft",legend=factsfacts,col=seq_along(facts),
       lty="solid",lwd=4,bg="white")
```

(ref:capapplinorm2)  Probability of occurrence for various scales of spatial aggregation. Aggregates are assumed to be square grids of $N \times N$ cells (i.e., $\nu=N^2$). The underlying logistic curve representing species occurrence as a function of environment followed a normal distribution (i.e., Eq. \ref{eq:normprob}) with $\mu=`r mu`$, $\sigma=`r sigma`$. $C$, the maximum probability value, was equal to `r Clow`.

```{r applinorm2,fig.cap="(ref:capapplinorm2)"}
yy = lapply(facts,function(fact) normfun.agg(x,mu,sigma,C=Clow,fact=fact))
yy = do.call(cbind,yy)

plot(x,yy[,1],lwd=4,type="l",ylim=c(0,1),
     xlab="Temperature (\u00B0C)",ylab="Prob. of occurence",
     main="Lower-prevalence normal prob. occ.")
for (k in 2:ncol(yy)) {
  lines(x,yy[,k],col=k,lwd=4)
}

legend("bottomleft",legend=factsfacts,col=seq_along(facts),
       lty="solid",lwd=4,bg="white")

```

For both the high (Fig. \@ref(fig:applinorm1)) and the low (Fig. \@ref(fig:applinorm2)) prevalence virtual species, aggregation has approximately the effect that one would expect from a two-sided logistic curve. On both sides of the environment-occurrence curve, aggregation has the effect of displacing the perceived core area of occurrence outward at a decreasing, approximately-logarithmic rate. The range of environmental conditions over which probability of occurrence is intermediate decreases as aggregation increases, but this decrease appears to stabalize after a certain level of aggregation (e.g., the maximum and minimum slopes on each side of the environment-occurrence distribution is approximately the same for the blue and cyan curves in Fig. \@ref(fig:applinorm1)) as it would for a logistic environment-occurrence relationship. 

These results suggest that analytical results for a logistic environment-occurrence relationship are approximately applicable to many other functional forms for the distribution of occurrence in environmental space.

<!-- Potential figure for paper not included in supplementary output. -->

```{r paper_figure2,fig.width=6,fig.asp=1.5,include=FALSE}

op = par(no.readonly = TRUE)

layout(matrix(1:2,ncol=1))

par(mar=0.1+c(5,4,2,2))

ff = c(1,4,16) # Special factors just for this
xxx = seq(beta-5*alpha,beta+10*alpha,length.out = 1000)
yyy = do.call(cbind,
            lapply(ff,function(fact) logisticFun.agg(xxx,alpha,beta,fact)))
inflections=sapply(ff,
       function(fact) inv.logisticFun.agg.inflection(alpha,beta,fact))

fff = seq(min(ff),max(ff),length.out=100)
iiff = sapply(fff,function(fact) inv.logisticFun.agg.inflection(alpha,beta,fact))
myf = function(fact,nu=fact^2) 1-1/(1+1/nu)^nu
iiffpp = myf(fff) # probability at inflection point

cols = c("red","green","blue")

plot(xxx,yyy[,1],lwd=4,type="l",col=cols[1],
     xlab="Temperature (\u00B0C)",ylab="Prob. of occurence")
for (k in 2:ncol(yyy)) {
  lines(xxx,yyy[,k],col=cols[k],lwd=4)
}

abline(v=inflections,col=cols[seq_along(inflections)],lwd=2,lty="dashed")

lines(iiff,iiffpp,col="black",lty="solid",lwd=6)
library(shape)
Arrowhead(max(iiff),max(iiffpp),arr.length=0.6,arr.width=0.4,arr.adj=1,arr.lwd=6)

legend("topright",legend=paste0(ff,"x",ff),col=cols[seq_along(ff)],
       lty="solid",lwd=4)

mtext("(a)",3,0.5,adj=0,font=2,cex=1.5)

yyy = lapply(ff,function(fact) normfun.agg(xxx,mu=beta,sigma=1.5*alpha,C=Clow,fact=fact))
yyy = do.call(cbind,yyy)

plot(xxx,yyy[,1],lwd=4,type="l",col=cols[1],
     xlab="Temperature (\u00B0C)",ylab="Prob. of occurence",
     ylim=c(0,1))
for (k in 2:ncol(yyy)) {
  lines(xxx,yyy[,k],col=cols[k],lwd=4)
}

legend("topright",legend=paste0(ff,"x",ff),col=cols[seq_along(ff)],
       lty="solid",lwd=4)

mtext("(b)",3,0.5,adj=0,font=2,cex=1.5)

par(op)
```


# Numerical exploration of hypothetical case study and model performance indicators {#numerical}

```{r createsquaredomain}
n = 160
minT = 4.5
maxT = 10.5

x = 1:n
y = 1:n

env.occ.func = function(y,b,minT=minT,maxT=maxT,n=max(y))
  minT + (y-1)^b / (n-1)^b * (maxT-minT)

env.occ.func2 = function(y,b,minT=minT,maxT=maxT,n=max(y))
  minT + (y-1)/(n-1) * (maxT-minT) + b*sin(2*pi*(y-1)/(n-1))

X = outer(x,y,function(x,y)x)
Y = outer(x,y,function(x,y)y)

c1 = 0
z1 = env.occ.func2(y,c1,minT,maxT,n)
p1 = logisticFun(z1,alpha,beta)
Z1 = outer(x,z1,function(x,y) y)
P1 = outer(x,p1,function(x,y) y)

c2 = 0.9
z2 = env.occ.func2(y,c2,minT,maxT,n)
p2 = logisticFun(z2,alpha,beta)
Z2 = outer(x,z2,function(x,y) y)
P2 = outer(x,p2,function(x,y) y)

c3 = -0.9
z3 = env.occ.func2(y,c3,minT,maxT,n)
p3 = logisticFun(z3,alpha,beta)
Z3 = outer(x,z3,function(x,y) y)
P3 = outer(x,p3,function(x,y) y)
```

(ref:capenvocc) Assumed relationships between spatial coordinates in the "latitudinal" direction (i.e., $y$ direction) and mean annual temperature. The red line shows a linear relationship (i.e., constant rate of change of temperature across space), the green line shows a relationship for which temperatures around $7.5^\circ \text{C}$, the inflection point of the unaggregated environment-occurrence relationship, are relatively common over space, and the blue line shows a relationship for which temperatures around $7.5^\circ \text{C}$ are relatively rare.

```{r envocc,fig.cap="(ref:capenvocc)"}
# Plot of 3 space-environment relationships ----
plot(y,z1,col="red",lwd=3,type="l",xlab="y",ylab="Temperature (\u00B0C)",
     main="Space-environment relationships")
lines(y,z2,col="green",lwd=3)
lines(y,z3,col="blue",lwd=3)
legend("bottomright",col=c("red","green","blue"),lwd=3,
       legend = c("Linear scenario","Common scenario","Rare scenario"))
```

Whereas the visualization above provides a basic demonstration of the theory, to understand how it might work in a real scenario and to examine the impact of aggregation on SDM model performance indicators, it is useful to consider hypothetical case studies based on virtual species distributed in a two-dimensional space. The habitat area is taken to be a square with `r n` units on each side, for a total of `r format(n^2,big.mark=",")` unaggregated grid cells. The spatial units of the grid cells (i.e., their physical size) have no impact on results, but so as to talk in concrete terms we can take them to be km.

We consider three different potential relationships between space and environmental conditions, here taken without loss of generality to be mean annual temperature in each grid cell (Fig. \@ref(fig:envocc)). In all three cases, mean annual temperature in the grid cells varies in the "latitudinal" (i.e., $y$ or vertical) dimension from $`r minT`^\circ \text{C}$ at the bottom of the domain to $`r maxT`^\circ \text{C}$ at the top of the domain. For the first relationship, temperature increases linearly (i.e., at a fixed rate) over the spatial domain (red curve in Fig. \@ref(fig:envocc)). In the other two cases, temperature increases at varying rates: the green curve in Fig. \@ref(fig:envocc) has temperature values approximately constant and around the inflection point of the virtual species (i.e., $`r beta`^\circ \text{C}$) for a wide range of $y$ values (i.e., from $y \approx 50$ to $y \approx 100$), whereas the blue curve in Fig. \@ref(fig:envocc) changes quickly on the $y$ axis for temperature values close to the inflection point of the virtual species. These differences in rates of change in the temperature gradient for the three types of landscapes mean that for the slow rate of change scenario of the green curve, the environments for which the probability of occurrence is intermediate are relatively common, whereas intermediate probabilities of occurrence are rare in the high-rate of change landscape given by the blue curve. As such, the space-environment relationship given by the green curve will at times be referred to as the "common scenario" and the space-environment relationship given by the blue curve will at times be referred to as the "rare scenario" (the red curve being referred to as the "linear scenario).

```{r aggregatefuncasestudy}
myagg = function(Z,n,nx=n,ny=n,FUN=mean) {
  x = 1:nrow(Z)
  y = 1:ncol(Z)
  
  cx = cut(x,breaks=seq(0.5,nrow(Z)+nx+0.5,nx))
  cy = cut(y,breaks=seq(0.5,ncol(Z)+ny+0.5,ny))
  
  CX = outer(cx,cy,function(x,y)x)
  CY = outer(cx,cy,function(x,y)y)
  
  a = aggregate(as.vector(Z),by=list(CX=as.vector(as.numeric(CX)),
                                     CY=as.vector(as.numeric(CY))),FUN=FUN)
  A = matrix(a[,3],nrow=length(unique(cx)))
  
  return(A)
}

myagg.occ = function(...,FUN=function(x) as.numeric(any(x>0)))
  myagg(...,FUN=FUN)

myagg.prob = function(...,FUN=function(x) 1 - prod(1-x))
  myagg(...,FUN=FUN)
```


```{r bootstrapcasestudy,eval=!file.exists("boot-linear-env-logistic-results.RDS")}
set.seed(197208) # Reset the random number generator
nb = 80
bootres = foreach(i=1:nb) %do% {
  # Use the same random draws for all 3 space-env relationships
  pp = matrix(runif(P1),nrow=nrow(P1))
  R11 = matrix(as.numeric(pp<=P1),nrow=nrow(P1))
  R22 = matrix(as.numeric(pp<=P2),nrow=nrow(P1))
  R33 = matrix(as.numeric(pp<=P3),nrow=nrow(P1))

  f = c(1,2,4,5,8,10,16)
  names(f) = paste0(f,"x",f)
  
  res = lapply(f,FUN=function(n){
    pp1 = aggfun(p1,n)
    pp2 = aggfun(p2,n)
    pp3 = aggfun(p3,n)
    X = myagg(X,n=n)  
    Y = myagg(Y,n=n)  
    ZZ1 = myagg(Z1,n=n)
    ZZ2 = myagg(Z2,n=n)
    ZZ3 = myagg(Z3,n=n)
    PP1 = myagg.prob(P1,n=n)
    PP2 = myagg.prob(P2,n=n)
    PP3 = myagg.prob(P3,n=n)
    RR1 = myagg.occ(R11,n=n)
    RR2 = myagg.occ(R22,n=n)
    RR3 = myagg.occ(R33,n=n)

    zz = as.vector(ZZ1)
    rr = as.vector(RR1)
    m1 = gam(rr~s(zz),family=binomial)
    pr1 = predict(m1,newdata=data.frame(zz=z1),type="response")
    
    zz = as.vector(ZZ2)
    rr = as.vector(RR2)
    m2 = gam(rr~s(zz),family=binomial)
    pr2 = predict(m2,newdata=data.frame(zz=z1),type="response")
    
    zz = as.vector(ZZ3)
    rr = as.vector(RR3)
    m3 = gam(rr~s(zz),family=binomial)
    pr3 = predict(m3,newdata=data.frame(zz=z1),type="response")
    
    return(list(x=X[,1],y=Y[1,],
                X=X,Y=Y,
                Z1=ZZ1,Z2=ZZ2,Z3=ZZ3,
                P1=PP1,P2=PP2,P3=PP3,
                p1.theory=pp1,p2.theory=pp2,p3.theory=pp3,
                p1=PP1[1,],p2=PP2[1,],p3=PP3[1,],
                R1=RR1,R2=RR2,R3=RR3,
                model1=m1,model2=m2,model3=m3,
                z=z1,
                predict1=pr1,predict2=pr2,predict3=pr3,
                scale=n))
  })
}

saveRDS(bootres,"boot-linear-env-logistic-results.RDS")
```

```{r}
bootres = readRDS("boot-linear-env-logistic-results.RDS")
res = bootres[[1]]
nb = length(bootres)
```

In all cases, the environment-occurrence relationship is take to be a logistic function of temperature with the same form as that used in the previous section on visualization of analytic results: $\beta=`r beta`$ and $\alpha=`r alpha`$. The combination of the space-environment relationships (e.g., the top panel in Fig. \@ref(fig:domainplots) presents the linear space-environment relationship) and the environment-occurrence relationship yields the spatial distributions of probability of occurrence (e.g., the middle panel in Fig. \@ref(fig:domainplots) shows that for the linear space-environment relationship). These distributions can be used to simulate potential distributions of presence-absence for the species by drawing one random number between zero and one for each grid cell of the model domain and comparing it with the probability of occurrence for that grid cell [@meynardTestingMethodsSpecies2019], one example of which is shown in the bottom panel of Fig. \@ref(fig:domainplots). `r nb` such potential distributions of presence-absence were randomly drawn. These were used as the basis for developing SDMs for each of the `r nb` presence-absence maps after aggregation using approach #2 at a variety of spatial scales ranging from 1x1 (i.e., no aggregation) to `r rev(names(bootres[[1]]))[1]`. SDMs were estimated using binomial GAM models for which probability of occurrence was assumed to be a simple smooth of mean annual temperature. From the GAM SDMs, deviance explained was extracted, predictions of probability of occurrence were calculated and these were used to estimate the area under the ROC curve (i.e., AUC).

Results from this process demonstrate how SDM performance and model estimated probability of occurrence behave as a function of scale of aggregation and the spatial distribution of environmental conditions. <!-- Both deviance explained (Fig. \@ref(fig:bootextractdevexpl)) and AUC (Fig. \@ref(fig:bootextractauc)) show similar patterns. -->For the linear space-environment relationship (top panel in <!--Figs. \@ref(fig:bootextractdevexpl) &-->Fig. \@ref(fig:bootextractauc)), aggregation initially improves AUC before it stabilizes and begins to decrease slightly on average. As scale of aggregation increases, so does variability in performance between realizations of presence-absence (i.e., large size of boxplots in <!--Figs. \@ref(fig:bootextractdevexpl) &-->Fig. \@ref(fig:bootextractauc)).

The initial increase in presence-absence classification rates (as measured by AUC) as a function of aggregation can be explained by the decrease in the range of temperatures yielding intermediate probabilities of occurrence as a result of aggregation (Fig. \@ref(fig:vistheory4)). The increased variability in performance as a function of scale of aggregation can be explained by the decreasing number of grid cells post aggregation (Fig. \@ref(fig:aggexamplesplot)) leading to larger random swings in the clarity of the relationship between presence-absence and temperature. 

Perhaps the most intriguing pattern is the decrease in AUC for larger scales of aggregation. This can be explained by the fact that increasingly large aggregates encompass a wider range of temperatures, thereby leading to mean environmental conditions over aggregates being a relatively poor indicator of the aggregate probability of occurrence (i.e., Eq. \@ref(eq:eq1)). This can be seen by considering that Eq. \@ref(eq:eq1) can be rewritten as:

$$
\tilde{p} = 1 - G^{\nu}
$$

where $G$ is the geometric mean of the individual probabilities of *absence* (i.e., one minus probability of occurrence) that compose the aggregate:

$$
G = \left[ \prod_{i=1}^{\nu} (1-p_i) \right]^{1/\nu}
$$

The discrepancy between the arithmetic mean (of environmental conditions that then are used to calculate a probability of occurrence at the mean environmental conditions) and the geometric mean (of the true probabilities of occurrence) grows as a function of both the range and the number of values within the mean, leading to decreased model performance for large aggregates encompassing a wide range of temperatures. Indeed, at the 16x16 scale of aggregation, the temperature range within an aggregate is $`r (maxT-minT)*0.1`^\circ \text{C}$, which is not small with respect to the range of temperatures leading to intermediate probabilities of occurrence (Fig. \@ref(fig:vistheory4)). This theory based on geometric means and arithmetic means also explains why model-estimated and Eq. \@ref(eq:eq1)-estimated probabilities of occurrence generally exceed probabilities of occurrence based on theory ignoring environmental heterogeneity within aggregates (Fig. \@ref(fig:modeltheoryenvocccomp)) because the geometric mean is always inferior to the arithmetic mean, meaning that:

$$
\tilde{p} = 1 - G^{\nu} > 1 - (1-\bar{p})^{\nu} = \tilde{\bar{p}}
$$

where $\bar{p}$ is the probability of occurrence for the mean environmental conditions of the aggregate.

When temperatures corresponding to intermediate probabilities of occurrence are relatively common in space (green curve in Fig. \@ref(fig:envocc)), unaggregated model performance indicators (left-hand side of middle panel in <!--Figs. \@ref(fig:bootextractdevexpl) &-->Fig. \@ref(fig:bootextractauc)) are far lower than those for a linear space-environment relationship. Aggregation at the 4x4 scale increases performance indicators to approximately the level of those for the linear space-environment relationship and performance indicators at the 16x16 scale exceed those of the linear space-environment relationship. The opposite tendencies are true when temperatures for which probability of occurrence are intermediate are relatively rare over space (bottom panel in <!--Figs. \@ref(fig:bootextractdevexpl) &-->Fig. \@ref(fig:bootextractauc)); in this case, performance indicators begin higher than those for the linear relationship, increase less with aggregation and decrease, in a relative sense, more at large scales of aggregation. These results can be explained by the change in temperatures that produce intermediate probabilities of occurrence as a function of scale of aggregation (Fig. \@ref(fig:vistheory5)). For the space-environment relationship given by the green curve in Fig. \@ref(fig:envocc), aggregation moves the temperatures that produce intermediate probabilities of occurrence from those that are relatively common over space to those that are relatively rare over space, causing a relative increase in performance indices (middle panel of Fig. \@ref(fig:bootextractauc)). The opposite occurs for the space-environment relationship given by the blue curve in Fig. \@ref(fig:envocc)  (bottom panel of Fig. \@ref(fig:bootextractauc)).

Theory ignoring heterogeneity in unaggregated grid cell probability of occurrence driven by variability in environmental conditions within aggregates represents reasonably well SDM estimates of probability of occurrence in all cases, however, discrepancies increase as scale of aggregation increases (Fig. \@ref(fig:modeltheoryenvocccomp)). This can be explained by the aforementioned differences between arithmetic and geometric means and the increasing "pixelization" of the model system. This effect is particularly visible at the 16x16 scale (bottom panel of Fig. \@ref(fig:modeltheoryenvocccomp)), for which the small number of grid cells leads to regular bumps in mean model-estimated probabilities of occurrence as a function of how many cells are randomly classified as presences in the model domain. This discretization also explains discrepancies between the application of Eq. \@ref(eq:eq1) to the underlying probability of occurrence (dots in Fig. \@ref(fig:modeltheoryenvocccomp)) and GAM model predictions (colored curves in Fig. \@ref(fig:modeltheoryenvocccomp)) as the finite number of cells only permits certain particular levels of species prevalence (for a given latitudinal level).

(ref:capdomainplots) Temperature (top), probability of occurrence (middle) and one example of presence-absence based on the probability of occurrence (bottom) for the case when temperature has a linear gradient over the y dimension. For the bottom panel, white and black grid cells indicate species absence and presence, respectively.

```{r domainplots,fig.width=6,fig.asp=2.5,fig.cap="(ref:capdomainplots)",out.height="80%"}
# Plot of temperature, prob of occurrence and a realization of pres-absence for the domain ----
op = par(mfrow=c(3,1))
image.plot(x,y,Z1,main="Temperature (\u00B0C)")

image.plot(x,y,P1,main="Probability of occurrence")

image(x,y,res$`1x1`$R1,main="Presence-Absence",col=c("white","black"))
par(op)
```

(ref:capaggexamplesplot) Examples of the impact of aggregation following approach #2 on perceived presence-absence. The underlying small-scale presence-absence distribution is as in the bottom panel of Fig. \@ref(fig:domainplots). The panels show aggregation at the 4x4 (top), 8x8 (middle) and 16x16 (bottom) scales. In all panels, white and black grid cells indicate assessments of species absence and presence, respectively, according to approach #2 to aggregating presence observations.


```{r aggexamplesplot,fig.width=6,fig.asp=2.5,fig.cap="(ref:capaggexamplesplot)",out.height="80%"}
# Example of aggregation applied to presence-absence for approach 2 ----
op = par(mfrow=c(3,1))
for (nn in c("4x4","8x8","16x16")) {
  r = res[[nn]]
  image(r$x,r$y,r$R1,main=nn,xlab="x",ylab="y",col=c("white","black"))
}
par(op)
```

<!-- Potential figure for paper not included in supplementary -->

```{r paper_aggexamplesplot,fig.width=14,fig.asp=1.4,include=FALSE}
# Figure is not quite working correctly due to margin and spacing issues
# Not sure how to fix it...
# Also image.plot somehow forces filling layout by row
op = par(no.readonly = TRUE)

layout(matrix(1:6,ncol=2)) # For some reason image.plot forces filling by row

imagePlot(x,y,Z1,main="Temperature (\u00B0C)",
          legend.mar=8.1,mar=0.1+c(7,4,4,6),cex=1)

imagePlot(x,y,P1,main="Probability of occurrence",
          legend.mar=8.1,mar=0.1+c(7,4,4,6),cex=1)

for (nn in c("1x1","4x4","8x8","16x16")) {
  r = res[[nn]]
  image(r$x,r$y,r$R1,main=nn,xlab="x",ylab="y",col=c("white","black"),
        legend.mar=6.1,mar=0.1+c(7,4,4,6),cex=1)
}
par(op)
```


(ref:capbootextractdevexpl) Deviance explained by GAM models as a function of scale of spatial aggregation and the functional form of the space-environment relationship. Box colors and panel titles correspond to the space-environment functional forms shown in Fig. \@ref(fig:envocc).

```{r bootextractdevexpl,fig.width=6,fig.asp=2.5,fig.cap="(ref:capbootextractdevexpl)",out.height="80%",include=FALSE}
# Deviance explained extracted from GAM models of bootstraps ----
de = list()
for (nn in paste0("model",1:3)) {
  de[[nn]] = foreach(i=1:length(bootres),.combine=rbind) %do% {
    sapply(bootres[[i]],function(r) summary(r[[nn]])$dev.expl)
  } |> as.data.frame() |> pivot_longer(cols=everything(),names_to="scale",values_to="dev.expl")
  de[[nn]]$scale = factor(de[[nn]]$scale,levels=unique(de[[nn]]$scale))
}

op = par(mfrow=c(3,1))
boxplot(dev.expl~scale,data=de[["model1"]],main="Linear scenario",col="red",ylim=c(0.4,1),
        ylab="Deviance explained by GAM model",xlab="Scale of aggregation")
grid(nx=NA,ny=NULL)
boxplot(dev.expl~scale,data=de[["model2"]],main="Common scenario",col="green",ylim=c(0.4,1),
        ylab="Deviance explained by GAM model",xlab="Scale of aggregation")
grid(nx=NA,ny=NULL)
boxplot(dev.expl~scale,data=de[["model3"]],main="Rare scenario",col="blue",ylim=c(0.4,1),
        ylab="Deviance explained by GAM model",xlab="Scale of aggregation")
grid(nx=NA,ny=NULL)
par(op)
```


(ref:capbootextractauc) Area under the ROC curve (AUC) of GAM model predictions as a function of scale of spatial aggregation and the functional form of the space-environment relationship. Box colors and panel titles correspond to the space-environment functional forms shown in Fig. \@ref(fig:envocc).

```{r bootextractauc,fig.width=6,fig.asp=2.5,fig.cap="(ref:capbootextractauc)",out.height="80%"}
# AUC from GAM models of bootstraps ----
au = list()
for (i in 1:3) {
  nn=paste0("model",i)
  RN=paste0("R",i)
  au[[nn]] = foreach(i=1:length(bootres),.combine=rbind) %do% {
    sapply(bootres[[i]],function(r) {
      pp=predict(r[[nn]])
      D = data.frame(id=seq_along(pp),pa=as.vector(r[[RN]]),pm=as.vector(pp))
      auc(D)$AUC
      })
  } |> as.data.frame() |> pivot_longer(cols=everything(),names_to="scale",values_to="auc")
  au[[nn]]$scale = factor(au[[nn]]$scale,levels=unique(au[[nn]]$scale))
}

op = par(mfrow=c(3,1))
boxplot(auc~scale,data=au[["model1"]],main="Linear scenario",col="red",ylim=c(0.9,1),
        ylab="AUC",xlab="Scale of aggregation")
grid(nx=NA,ny=NULL)
boxplot(auc~scale,data=au[["model2"]],main="Common scenario",col="green",ylim=c(0.9,1),
        ylab="AUC",xlab="Scale of aggregation")
grid(nx=NA,ny=NULL)
boxplot(auc~scale,data=au[["model3"]],main="Rare scenario",col="blue",ylim=c(0.9,1),
        ylab="AUC",xlab="Scale of aggregation")
grid(nx=NA,ny=NULL)
par(op)
```

<!-- Potential figure for paper not included in supplmentary output -->

```{r paper_space_env_auc,fig.width=12,fig.asp=1.55,include=FALSE}
lyt = matrix(c(NA,1,1,NA,
               2,2,3,3,
               4,4,5,5,
               6,6,7,7),nrow=4,byrow=TRUE)

xxx = bootres[[1]][["1x1"]]
y = xxx$y

X = xxx$X
Y = xxx$Y

Z1 = xxx$Z1
Z2 = xxx$Z2
Z3 = xxx$Z3

z1 = Z1[1,]
z2 = Z2[1,]
z3 = Z3[1,]

tt = range(z1)
#breaks = seq(floor(tt[1]),ceiling(tt[2]),0.5)
breaks = seq(tt[1],tt[2],0.5)
tt2 = tt + c(-1e-10,1e-10)
breaks2 = seq(tt2[1],tt2[2],length.out=length(breaks))

lbs = as.character(breaks)
lbs[seq(1,length(lbs),2)] = ""

#cols = tim.colors(n=length(breaks)-1)
cols = two.colors(n=length(breaks)-1,start="grey90",end="grey10",middle="grey50")

dd = data.frame(y=y,z1=z1,z2=z2,z3=z3)
DD = data.frame(X=as.vector(X),Y=as.vector(Y),
                Z1=as.vector(Z1),Z2=as.vector(Z2),Z3=as.vector(Z3))

base_size=20
label_size=1.3*base_size

# (a) ------
gb = ggplot(data=dd,aes(x=y)) +
  geom_line(aes(y=z1),col="red",lwd=3) +
  geom_line(aes(y=z2),col="green",lwd=3) +
  geom_line(aes(y=z3),col="blue",lwd=3) +
  theme_bw(base_size=base_size) +
  ylab("Temperature (\u00B0C)")

gba = arrangeGrob(gb,top=textGrob("(a)",x=0.1,gp=gpar(fontface="bold",fontsize=label_size)))

# (b) ------
myguide = guide_legend(keyheight = unit(0.013,"npc"),reverse=TRUE)

gb = ggplot(data=DD,mapping=aes(x=X,y=Y,fill=Z1)) + geom_raster() + 
  theme_bw(base_size=base_size) + 
  scale_x_continuous(expand=c(0,0)) + scale_y_continuous(expand=c(0,0)) +
  scale_fill_stepsn(colors=cols,breaks=breaks,guide=myguide,labels=lbs) +
  labs(fill="\u00B0C")

gbb = arrangeGrob(gb,top=textGrob("(b)",x=0.1,gp=gpar(fontface="bold",fontsize=label_size)))

# (c) ------
gb = ggplot(data=au[["model1"]],mapping=aes(x=scale,y=auc)) +
  geom_boxplot(fill="red") + 
  theme_bw(base_size=base_size) + ylim(c(0.9,1)) +
  ylab("AUC") + xlab("Scale of aggregation")

gbc = arrangeGrob(gb,top=textGrob("(c)",x=0.1,gp=gpar(fontface="bold",fontsize=label_size)))

# (d) ------
gb = ggplot(data=DD,mapping=aes(x=X,y=Y,fill=Z2)) + geom_raster() + 
  theme_bw(base_size=base_size) + 
  scale_x_continuous(expand=c(0,0)) + scale_y_continuous(expand=c(0,0)) +
  scale_fill_stepsn(colors=cols,breaks=breaks,guide=myguide,labels=lbs) +
  labs(fill="\u00B0C")

gbd = arrangeGrob(gb,top=textGrob("(d)",x=0.1,gp=gpar(fontface="bold",fontsize=label_size)))

# (e) ------
gb = ggplot(data=au[["model2"]],mapping=aes(x=scale,y=auc)) +
  geom_boxplot(fill="green") + 
  theme_bw(base_size=base_size) + ylim(c(0.9,1)) +
  ylab("AUC") + xlab("Scale of aggregation")

gbe = arrangeGrob(gb,top=textGrob("(e)",x=0.1,gp=gpar(fontface="bold",fontsize=label_size)))

# (f) ------
gb = ggplot(data=DD,mapping=aes(x=X,y=Y,fill=Z3)) + geom_raster() + 
  theme_bw(base_size=base_size) + 
  scale_x_continuous(expand=c(0,0)) + scale_y_continuous(expand=c(0,0)) +
  scale_fill_stepsn(colors=cols,breaks=breaks,guide=myguide,labels=lbs) +
  labs(fill="\u00B0C")

gbf = arrangeGrob(gb,top=textGrob("(f)",x=0.1,gp=gpar(fontface="bold",fontsize=label_size)))

# (g) ------
gb = ggplot(data=au[["model3"]],mapping=aes(x=scale,y=auc)) +
  geom_boxplot(fill="blue") + 
  theme_bw(base_size=base_size) + ylim(c(0.9,1)) +
  ylab("AUC") + xlab("Scale of aggregation")

gbg = arrangeGrob(gb,top=textGrob("(g)",x=0.1,gp=gpar(fontface="bold",fontsize=label_size)))

# Put it all together --------
grid.arrange(gba,gbb,gbc,gbd,gbe,gbf,gbg,layout_matrix=lyt)
```


(ref:capmodeltheoryenvocccomp) Theoretical and model estimated environment-occurrence relationships at 4x4 (top), 8x8 (middle) and 16x16 (bottom) scales of aggregation. In each panel, the black curve indicates the theoretical probability of occurrence ignoring environmental heterogeneity within aggregate as shown in Fig. \@ref(fig:vistheory1). The red, green and blue curves indicate GAM model predictions for the environment-occurrence relationship based on the space-environment relationship of the corresponding color in Fig. \@ref(fig:envocc). Probabilities have been averaged over `r nb` random realizations of species occurrence over the model domain (one example of which is shown in Fig. \@ref(fig:aggexamplesplot)). The red, green and blue dots correspond to theoretical predictions of probability of occurrence based on application of Eq. \@ref(eq:eq1) to the underlying probability of species occurrence over the model domain (e.g., for the red dots, this probability of occurrence is shown in the middle panel of Fig. \@ref(fig:domainplots)). These theoretical predictions are only shown for discrete values of temperature because these are the finite set of averages over the aggregates in the model system.

```{r modeltheoryenvocccomp,fig.width=6,fig.asp=2.5,fig.cap="(ref:capmodeltheoryenvocccomp)",out.height="70%"}
# GAM model probabilities of occurrences confronted with theory -------
geom.mean = function(x) exp(mean(log(x)))

ff = names(bootres[[1]])

preds1 = foreach(f=ff) %do% {
  foreach(i=seq_along(bootres),.combine=cbind) %do% {
    bootres[[i]][[f]]$predict1
  }
}
names(preds1) = ff
preds1mean = sapply(preds1,function(x) apply(x,1,mean))
preds1gmean = sapply(preds1,function(x) apply(x,1,geom.mean))

preds2 = foreach(f=ff) %do% {
  foreach(i=seq_along(bootres),.combine=cbind) %do% {
    bootres[[i]][[f]]$predict2
  }
}
names(preds2) = ff
preds2mean = sapply(preds2,function(x) apply(x,1,mean))
preds2gmean = sapply(preds2,function(x) apply(x,1,geom.mean))

preds3 = foreach(f=ff) %do% {
  foreach(i=seq_along(bootres),.combine=cbind) %do% {
    bootres[[i]][[f]]$predict3
  }
}
names(preds3) = ff
preds3mean = sapply(preds3,function(x) apply(x,1,mean))
preds3gmean = sapply(preds3,function(x) apply(x,1,geom.mean))

op = par(mfrow=c(3,1))
for (nn in c("4x4","8x8","16x16")) {
  plot(z1,bootres[[1]][[nn]]$p1.theory,type="l",xlim=c(8,10.5),
       xlab="Temperature (\u00B0C)",
       ylab="Probability of occurrence",
       main=nn)
  lines(z1,preds1mean[,nn],col="red")
  #lines(bootres[[1]][[nn]]$Z1[1,],bootres[[1]][[nn]]$P1[1,],col="red",lty="dashed")
  
  lines(z1,preds2mean[,nn],col="green")
  #lines(bootres[[1]][[nn]]$Z2[1,],bootres[[1]][[nn]]$P2[1,],col="green",lty="dashed")
  
  lines(z1,preds3mean[,nn],col="blue")
  #lines(bootres[[1]][[nn]]$Z3[1,],bootres[[1]][[nn]]$P3[1,],col="blue",lty="dashed")
  
  points(bootres[[1]][[nn]]$Z1[1,],bootres[[1]][[nn]]$P1[1,],col="red",pch=19)
  points(bootres[[1]][[nn]]$Z2[1,],bootres[[1]][[nn]]$P2[1,],col="green",pch=19)
  points(bootres[[1]][[nn]]$Z3[1,],bootres[[1]][[nn]]$P3[1,],col="blue",pch=19)
}
par(op)
```




```{r exploregeommean,eval=FALSE}
# Explores how geometric means behave relative to arithmetic means as a unction of sample size and range of values.
# Not run, but keeping around in case needed for discussion sake.
yy = foreach(n=1:20) %do% {
  m = matrix(runif(n*1e4,min=0,max=0.5),nrow=n)
  list(amean = apply(m,2,mean),
       gmean = apply(m,2,geom.mean))
}
zz = foreach(n=1:20,.combine=cbind) %do% {
  yyy = yy[[n]]
  yyy$amean - yyy$gmean
}

plot(apply(zz,2,mean))
```


# Limits to the applicability of theoretical results

There are a number of limits to the applicability of the theoretical results for approach #2 developed above. One was explored in the previous section, namely the impact of environmental heterogeneity within spatial aggregates on the applicability of theoretical results assuming constant environmental conditions. However, there are at least two other limits that are worth considering. Key to the results above for aggregation approach #2 are the infinite tales of the probability distribution. For a logistic or normal probability of occurrence, there are no areas for which probability of occurrence is truly zero. In real cases, there may, however, be situations for which environmental conditions are truly inhospitable to a species and the probability of occurrence is identically zero (e.g., alligators in the Arctic). More generally, as spatial scale of aggregation grows, one may reach scales for which the environmental, biological and ecosystemic processes driving occurrence are no longer the same, thereby leading to divergences between occurrence gradients that are reasonable at one scale and those that are reasonable at another scale. 

Regarding the first of these limits, if probability of occurrence is identically zero for some environmental conditions, then the movement of the inflection point in the aggregated probability of occurrence distribution towards areas that had low probability of occurrence before aggregation will be blocked at these fundamental barriers to presence. In this case, the aggregated probability of occurrence will approach a threshold distribution as scale of aggregation is increased. 

Given this context, the results above exploring the effects of aggregation should be thought of as applicable for intermediate spatial scales, above those for which temporal and spatial autocorrelation in presence-absence are important (i.e., the scale at which nearest-neighbor colonization and extinction events are important), but below those over which fundamental barriers to life or major changes in what processes determine occurrence are likely to occur. For example, the scale of a single forest track would likely be too small for many species (unless the species has very short dispersal potential), and the scale of an entire continent would likely be too large for many species for this theory to apply without some modification. Intermediate scales of countries or regions would likely be ideal for applying the theory developed above.

Another limit relates to the SDM development process itself. In our virtual species analyses, we are fortunate enough to know exactly what environmental variable is driving changes in probability of occurrence. However, in real situations, one rarely has access to the precise environmental variables that directly drive occurrence. Instead, one uses proxies that presumably are more or less correlated with the true drivers of occurrence. In this case, the theory and simulations developed above should be approximately applicable, though one would expect that model performance indicators would be significantly lower than those seen in our simulations. One can imagine, however, cases where the process of averaging environmental variables over larger scales may produce variables that are more or less correlated with the true drivers of occurrence (i.e., occurrence and environment are related on specific scales of spatial variability, but not others). This could cause changes in model performance indices that are not purely driven by aggregation itself, but rather by the processes underlying occurrence.

# References

